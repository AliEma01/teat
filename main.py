# -*- coding: utf-8 -*-
"""Untitled2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Q92gY2EA2fnmy5dhbyUNXzv8YYJHut7m
"""

from fastapi import FastAPI
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import jdatetime
from datetime import datetime
import json
import os


app = FastAPI()

@app.post("/run")
def run_task():

    # ----------------------------
    # 1) احراز هویت
    # ----------------------------
    scope = [
        "https://spreadsheets.google.com/feeds",
        "https://www.googleapis.com/auth/drive"
    ]
    print(">>>> ENV LENGTH:", len(os.environ.get("GOOGLE_CREDS_JSON", "")))

    creds_json_str = os.environ.get("GOOGLE_CREDS_JSON")
    creds_dict = json.loads(creds_json_str)
    creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
    client = gspread.authorize(creds)
    # ----------------------------
    # 2) باز کردن شیت‌ها
    # ----------------------------
    sheet_file = client.open("unload_data")
    raw_sheet   = sheet_file.worksheet("raw_data")
    final_data  = sheet_file.worksheet("final_data")
    input_sheet = sheet_file.worksheet("input")
    
    # ----------------------------
    # 3) ورودی‌ها
    # ----------------------------
    input_data = final_data.get_values("A1:E1")
    
    min_perc_color  = float(input_data[0][3])
    range_          = int(input_data[0][4])
    length_of_range = float(input_data[0][2])
    
    city_deadlines_raw = input_sheet.get_values("G1:H200")
    city_deadlines = {
        r[0].strip(): int(r[1])
        for r in city_deadlines_raw
        if len(r) == 2 and r[0] and r[1]
    }
    
    # ----------------------------
    # 4) خواندن raw_data
    # ----------------------------
    raw_data = raw_sheet.get_all_values()
    df = pd.DataFrame(raw_data[1:], columns=raw_data[0])
    
    # ----------------------------
    # 5) تاریخ شمسی → میلادی
    # ----------------------------
    def jalali_to_gregorian(x):
        try:
            y, m, d = map(int, x.replace("-", "/").split("/"))
            return jdatetime.date(y, m, d).togregorian()
        except:
            return None
    
    df["gregorian_date"] = df.iloc[:, 0].apply(jalali_to_gregorian)
    df["gregorian_date"] = pd.to_datetime(df["gregorian_date"])
    
    start_date = pd.to_datetime(input_data[0][0])
    end_date   = pd.to_datetime(input_data[0][1])
    
    df = df[
        (df["gregorian_date"] >= start_date) &
        (df["gregorian_date"] <= end_date)
    ]
    
    # ----------------------------
    # 6) عددی‌سازی
    # ----------------------------
    def clean_number(x):
        if x is None or str(x).strip() == "":
            return 0
        s = str(x)
        s = s.translate(str.maketrans("۰۱۲۳۴۵۶۷۸۹", "0123456789"))
        s = s.replace(",", "").replace("٬", "").replace(" ", "")
        try:
            return float(s)
        except:
            return 0
    
    value_cols = df.columns[2:-1]
    df.loc[:, value_cols] = (
        df[value_cols]
        .applymap(clean_number)
        .div(length_of_range)
        .round(2)
    )
    
    # ----------------------------
    # 7) گروه‌بندی
    # ----------------------------
    group_col = df.columns[1]
    
    df = (
        df.groupby(group_col)[value_cols]
        .sum()
        .reset_index()
        .rename(columns={group_col: "hour"})
    )
    
    df["hour"] = pd.to_numeric(df["hour"], errors="coerce")
    df = df.sort_values("hour").reset_index(drop=True)
    
    # ----------------------------
    # 7.5) حذف ستون‌های کاملاً صفر
    # ----------------------------
    non_zero_cols = [c for c in value_cols if df[c].sum() != 0]
    df = df[["hour"] + non_zero_cols]
    
    # ----------------------------
    # ----------------------------
    # 8) محاسبه درصدها (FIXED)
    # ----------------------------
    for c in non_zero_cols:
        # اجبار به عددی
        df[c] = pd.to_numeric(df[c], errors="coerce").fillna(0)
    
        total = df[c].sum()
    
        if total == 0:
            pct = pd.Series([0] * len(df))
        else:
            pct = (df[c] / total * 100).round(1)
    
        df.insert(
            df.columns.get_loc(c) + 1,
            f"درصد_{c}",
            pct
        )
    
    # ----------------------------
    # 9) پاک‌سازی کامل از ستون F به بعد (۲۰ ستون اضافه)
    # ----------------------------
    values = final_data.get_all_values()
    rows = len(values)
    cols = len(values[0]) if values else 0
    
    start_col = 6
    end_col = max(cols + 20, start_col)
    end_letter = gspread.utils.rowcol_to_a1(1, end_col).replace("1", "")
    
    final_data.batch_clear([f"F1:{end_letter}{rows}"])
    
    # پاک کردن رنگ‌ها
    final_data.spreadsheet.batch_update({
        "requests": [{
            "repeatCell": {
                "range": {
                    "sheetId": final_data.id,
                    "startRowIndex": 0,
                    "endRowIndex": rows,
                    "startColumnIndex": 5,
                    "endColumnIndex": end_col
                },
                "cell": {"userEnteredFormat": {"backgroundColor": None}},
                "fields": "userEnteredFormat.backgroundColor"
            }
        }]
    })
    
    # ----------------------------
    # 10) نوشتن داده
    # ----------------------------
    final_data.update(
        "F1",
        [df.columns.tolist()] + df.values.tolist()
    )
    
    # ----------------------------
    # 12) رنگ‌ها + لاگ دلیل رنگ نشدن (FINAL / FIXED)
    # ----------------------------
    
    values = final_data.get_all_values()
    header = values[0]
    HOUR_COL = header.index("hour")
    
    def to_float(x):
        try:
            if x in ("", None):
                return None
            s = str(x).strip().replace(",", "").replace("٬", "")
            return float(s)
        except:
            return None
    
    # شدت رنگ – جلوگیری از سفید شدن
    def intensity(x):
        return 0.45 + 0.55 * x   # حداقل 0.45 ، حداکثر 1
    
    def red(i):    
        return {"red": 1, "green": 1-i, "blue": 1-i}
    
    def green(i):  
        return {"red": 1-i, "green": 1, "blue": 1-i}
    
    def yellow(i): 
        return {"red": 1, "green": 1, "blue": 1-i}
    
    # ----------------------------
    # محاسبه min / max فقط برای غیر تهران
    # ----------------------------
    other_values = []
    
    for ci, name in enumerate(header):
        if not name.startswith("درصد_"):
            continue
    
        city = name.replace("درصد_", "")
        if city == "تهران":
            continue
        if city not in city_deadlines:
            continue
    
        val_col = ci - 1
    
        for r in range(1, len(values)):
            v = to_float(values[r][val_col])
            if v is not None:
                other_values.append(v)
    
    if other_values:
        min_val = min(other_values)
        max_val = max(other_values)
    else:
        min_val, max_val = 0, 1
    
    def normalize(v):
        if max_val == min_val:
            return 1.0
        return (v - min_val) / (max_val - min_val)
    
    # ----------------------------
    # رنگ‌آمیزی + لاگ
    # ----------------------------
    requests = []
    not_colored_log = []
    
    for ci, name in enumerate(header):
        if not name.startswith("درصد_"):
            continue
    
        city = name.replace("درصد_", "")
        if city not in city_deadlines:
            not_colored_log.append(f"❌ ستون {city} | ددلاین ندارد")
            continue
    
        val_col  = ci - 1
        perc_col = ci
        deadline = city_deadlines[city]
    
        start_green = deadline - range_
        end_green   = deadline - 1
    
        for r in range(1, len(values)):
            hour = to_float(values[r][HOUR_COL])
            val  = to_float(values[r][val_col])
            perc = to_float(values[r][perc_col])
    
            # داده نامعتبر
            if hour is None or val is None:
                not_colored_log.append(
                    f"رد شد | شهر:{city} | سطر:{r} | hour یا value نامعتبر"
                )
                continue
    
            hour = int(hour)
    
            # ----------------------------
            # تعیین زون (بدون تغییر)
            # ----------------------------
            if start_green <= hour <= end_green:
                zone = "green"
            else:
                if start_green >= 16:
                    if 12 <= hour < start_green:
                        zone = "yellow"
                    else:
                        zone = "red"
                elif 12 <= start_green < 16:
                    if (start_green - 4) <= hour < start_green:
                        zone = "yellow"
                    else:
                        zone = "red"
                else:
                    zone = "red"
    
            # ----------------------------
            # شرط درصد (فقط زرد و قرمز)
            # ----------------------------
            if zone != "green":
                if perc is None:
                    not_colored_log.append(
                        f"رد شد | شهر:{city} | ساعت:{hour} | zone:{zone} | درصد خالی"
                    )
                    continue
    
                if perc < min_perc_color:
                    not_colored_log.append(
                        f"رد شد | شهر:{city} | ساعت:{hour} | zone:{zone} | درصد {perc} < {min_perc_color}"
                    )
                    continue
    
            # ----------------------------
            # شدت رنگ (تنها تغییر مجاز)
            # ----------------------------
            if city == "تهران":
                i = 1.0
            else:
                i = intensity(normalize(val))
    
            color = (
                green(i) if zone == "green"
                else yellow(i) if zone == "yellow"
                else red(i)
            )
    
            # رنگ‌کردن مقدار و درصد
            for c in (val_col, perc_col):
                requests.append({
                    "repeatCell": {
                        "range": {
                            "sheetId": final_data.id,
                            "startRowIndex": r,
                            "endRowIndex": r + 1,
                            "startColumnIndex": c,
                            "endColumnIndex": c + 1
                        },
                        "cell": {
                            "userEnteredFormat": {
                                "backgroundColor": color
                            }
                        },
                        "fields": "userEnteredFormat.backgroundColor"
                    }
                })
    
    # ----------------------------
    # اجرای رنگ‌ها
    # ----------------------------
    if requests:
        final_data.spreadsheet.batch_update({"requests": requests})
    
    # برای دیباگ در صورت نیاز:
    # for x in not_colored_log:
    #     print(x)
