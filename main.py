# -*- coding: utf-8 -*-
"""Untitled2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Q92gY2EA2fnmy5dhbyUNXzv8YYJHut7m
"""

from fastapi import FastAPI
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import jdatetime
from datetime import datetime
import json
import os


app = FastAPI()

@app.post("/run")
def run_task():

    # ----------------------------
    # 1) Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
    # ----------------------------
    scope = [
        "https://spreadsheets.google.com/feeds",
        "https://www.googleapis.com/auth/drive"
    ]
    print(">>>> ENV LENGTH:", len(os.environ.get("GOOGLE_CREDS_JSON", "")))

    creds_json_str = os.environ.get("GOOGLE_CREDS_JSON")
    creds_dict = json.loads(creds_json_str)
    creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
    client = gspread.authorize(creds)

    # ----------------------------
    # 2) Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø´ÛŒØªâ€ŒÙ‡Ø§
    # ----------------------------
    sheet_file = client.open("unload_data")
    raw_sheet = sheet_file.worksheet("raw_data")
    final_sheet = sheet_file.worksheet("final_data")
    input_sheet = sheet_file.worksheet("input")
    
    # ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
    input_data = final_sheet.get_values('A1:E1')
    min_perc_color = float(input_data[0][3])   # Ø¢Ø³ØªØ§Ù†Ù‡ Ø¯Ø±ØµØ¯
    range_ = int(input_data[0][4])             # Ø³Ø§Ø¹Øª Ù‚Ø¨Ù„ Ø§Ø² Ø¯Ø¯Ù„Ø§ÛŒÙ†
    length_of_range = float(input_data[0][2])             # ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ù…ÙˆØ«Ø±

    # ÙˆØ±ÙˆØ¯ÛŒ Ø¯Ø¯Ù„Ø§ÛŒÙ† Ø´Ù‡Ø±Ù‡Ø§
    city_deadlines_raw = input_sheet.get_values('G1:H200')
    city_deadlines = {row[0].strip(): int(row[1]) for row in city_deadlines_raw if len(row) == 2}
    
    # ----------------------------
    # 3) Ø®ÙˆØ§Ù†Ø¯Ù† raw_data â†’ DataFrame
    # ----------------------------
    raw_data = raw_sheet.get_all_values()
    df = pd.DataFrame(raw_data[1:], columns=raw_data[0])
    
    # ----------------------------
    # 4) ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ â†’ Ù…ÛŒÙ„Ø§Ø¯ÛŒ
    # ----------------------------
    def jalali_to_gregorian(jalali_str):
        try:
            parts = jalali_str.replace('-', '/').split('/')
            y, m, d = map(int, parts)
            g_date = jdatetime.date(y, m, d).togregorian()
            return g_date.strftime("%Y-%m-%d")
        except:
            return None
    
    df["gregorian_date"] = df.iloc[:, 0].apply(jalali_to_gregorian)
    
    # ----------------------------
    # 5) ÙÛŒÙ„ØªØ± ØªØ§Ø±ÛŒØ®
    # ----------------------------
    start_date = pd.to_datetime(input_data[0][0])
    end_date = pd.to_datetime(input_data[0][1])
    
    df["gregorian_date"] = pd.to_datetime(df["gregorian_date"])
    df_filtered = df[(df["gregorian_date"] >= start_date) &
                     (df["gregorian_date"] <= end_date)]
    
    # ----------------------------
    # 6) Ø¹Ø¯Ø¯ÛŒâ€ŒØ³Ø§Ø²ÛŒ
    # ----------------------------
    def clean_number(x):
        if x is None:
            return 0
        s = str(x).strip()
        if s == "":
            return 0
    
        # Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ â†’ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
        persian = "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"
        english = "0123456789"
        s = s.translate(str.maketrans(persian, english))
    
        # Ø­Ø°Ù Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§
        s = s.replace(",", "").replace("Ù¬", "").replace(" ", "")
    
        try:
            return float(s)
        except:
            return 0
    
    value_cols = df_filtered.columns[2:-1]
    df_filtered.loc[:, value_cols] = (df_filtered[value_cols].applymap(clean_number)/length_of_range).round(2)

    # ----------------------------
    # 7) Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
    # ----------------------------
    group_col = df_filtered.columns[1]
    grouped_sum = (
        df_filtered.groupby(group_col)[value_cols].sum().reset_index()
    )
    
    df = grouped_sum.copy()
    df["hour"] = pd.to_numeric(df["hour"], errors="coerce")
    df = df.sort_values("hour").reset_index(drop=True)
    
    # ----------------------------
    # 8) Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯Ù‡Ø§ (FIXED)
    # ----------------------------
    cols = df.columns.drop("hour")
    
    for c in cols:
        # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ù‚Ø·Ø¹ÛŒ Ø§Ø² Ø¹Ø¯Ø¯ÛŒ Ø¨ÙˆØ¯Ù†
        df[c] = pd.to_numeric(df[c], errors="coerce").fillna(0)
    
        total = df[c].sum()
    
        if total == 0:
            pct = 0
        else:
            pct = (df[c] / total * 100).round(1)
    
        df.insert(
            df.columns.get_loc(c) + 1,
            f"Ø¯Ø±ØµØ¯_{c}",
            pct
        )
    
    # ----------------------------
    # 9) Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ (Ù…Ù‚Ø§Ø¯ÛŒØ± + ÙØ±Ù…Øªâ€ŒÙ‡Ø§)
    # ----------------------------
    final_data = sheet_file.worksheet("final_data")
    
    num_rows = len(final_data.get_all_values())
    num_cols = len(final_data.row_values(1))
    
    if num_cols >= 6:
        end_col = gspread.utils.rowcol_to_a1(1, num_cols).replace("1", "")
        final_data.batch_clear([f"F1:{end_col}{num_rows}"])
    
    # ----------------------------
    # 10 Ù†ÙˆØ´ØªÙ† Ø®Ø±ÙˆØ¬ÛŒ Ø§Ø² F1
    # ----------------------------
    data = [df.columns.tolist()] + df.values.tolist()
    final_data.update("F1", data)
    
    # ----------------------------
    # 11) Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    # ----------------------------
    values = final_data.get_all_values()
    if not values:
        values = []
    
    header = values[0] if len(values) > 0 else []
    num_rows = len(values)
    num_cols = len(header)
    
    clear_requests = [
        {
            "repeatCell": {
                "range": {
                    "sheetId": final_data.id,
                    "startRowIndex": 1,  # ÙÙ‚Ø· Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ØŒ Ù‡Ø¯Ø± Ø­ÙØ¸ Ø´ÙˆØ¯
                    "endRowIndex": num_rows,
                    "startColumnIndex": 0,
                    "endColumnIndex": num_cols
                },
                "cell": {"userEnteredFormat": {"backgroundColor": None}},
                "fields": "userEnteredFormat.backgroundColor"
            }
        }
    ]
    
    final_data.spreadsheet.batch_update({"requests": clear_requests})
    
    # # ----------------------------
    # # 12) ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒÙ†/Ù…Ø§Ú©Ø³ Ø¨Ø±Ø§ÛŒ Heatmap (Ø¨Ù‡ Ø¬Ø² ØªÙ‡Ø±Ø§Ù†)
    # # ----------------------------
    
    # def parse_number_cell(x):
    #     try:
    #         s = str(x).strip()
    #         if s == "" or s.lower() in ["-", "n/a", "nan"]:
    #             return None
    #         s = s.replace(',', '').replace('Ù¬', '').replace(' ', '').replace('%', '')
    #         s = s.replace('\u2212', '-').replace('\u2011', '-')
    #         return float(s)
    #     except:
    #         return None
    
    # # Ø³ØªÙˆÙ† hour
    # try:
    #     HOUR_COL = header.index("hour")
    # except:
    #     HOUR_COL = None
    
    # all_raw_values_others = []
    # candidates = []
    
    # for col_idx, col_name in enumerate(header):
    #     if not isinstance(col_name, str):
    #         continue
    
    #     name = col_name.strip()
    #     if name.startswith("Ø¯Ø±ØµØ¯_"):
    #         city = name.replace("Ø¯Ø±ØµØ¯_", "").strip()
    #         val_col_idx = col_idx - 1
    #         perc_col_idx = col_idx
    
    #         if city not in city_deadlines:
    #             continue
    
    #         deadline = city_deadlines[city]
    #         start_green = deadline - range_
    #         end_green   = deadline - 1
    
    #         for r in range(1, num_rows):
    
    #             raw_hour = values[r][HOUR_COL] if HOUR_COL is not None else None
    #             raw_val  = values[r][val_col_idx]
    #             raw_perc = values[r][perc_col_idx]
    
    #             hour_val = parse_number_cell(raw_hour)
    #             val_val  = parse_number_cell(raw_val)
    #             perc_val = parse_number_cell(raw_perc)
    
    #             if hour_val is None or val_val is None or perc_val is None:
    #                 continue
    #             if perc_val < min_perc_color:
    #                 continue
    
    #             # ØªÙ‡Ø±Ø§Ù† ÙˆØ§Ø±Ø¯ Heatmap Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
    #             if city != "ØªÙ‡Ø±Ø§Ù†":
    #                 all_raw_values_others.append(val_val)
    
    #             candidates.append((r, val_col_idx, perc_col_idx, int(hour_val),
    #                                val_val, perc_val, city,
    #                                start_green, end_green, deadline))
    
    # # ÙÙ‚Ø· ØºÛŒØ± ØªÙ‡Ø±Ø§Ù†
    # if len(all_raw_values_others) > 0:
    #     others_min = min(all_raw_values_others)
    #     others_max = max(all_raw_values_others)
    # else:
    #     others_min = 0
    #     others_max = 1
    
    # def normalize_value(v):
    #     if others_max == others_min:
    #         return 1
    #     return (v - others_min) / (others_max - others_min)
    
    # # ----------------------------
    # # 13) Ø±Ù†Ú¯â€ŒÙ‡Ø§ + Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø³ÙÛŒØ¯ Ø´Ø¯Ù†
    # # ----------------------------
    # def fix_intensity(x):
    #     return 0.25 + x * 0.75
    
    # def color_red(i):
    #     return {"red": 1.0, "green": 1.0 - i, "blue": 1.0 - i}
    
    # def color_green(i):
    #     return {"red": 1.0 - i, "green": 1.0, "blue": 1.0 - i}
    
    # def color_yellow(i):
    #     return {"red": 1.0, "green": 1.0, "blue": 1.0 - i}
    
    # # ----------------------------
    # # 14) Ø±Ù†Ú¯â€ŒØ±Ø²ÛŒ Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§
    # # ----------------------------
    # requests = []
    
    # for (r, val_col_idx, perc_col_idx, hour, val_val, perc_val, city,
    #      start_green, end_green, deadline) in candidates:
    
    #     # ØªØ¹ÛŒÛŒÙ† Ø²ÙˆÙ†
    #     if start_green <= hour <= end_green:
    #         zone = "green"
    #     elif hour < start_green:
    #         zone = "yellow"
    #     else:
    #         zone = "red"
    
    #     #  ØªÙ‡Ø±Ø§Ù† â†’ Ø´Ø¯Øª Ø«Ø§Ø¨Øª Ùˆ Ú©Ø§Ù…Ù„
    #     if city == "ØªÙ‡Ø±Ø§Ù†":
    #         intensity = 1.0
    #     else:
    #         intensity_raw = normalize_value(val_val)
    #         intensity = fix_intensity(intensity_raw)
    
    #     # Ø§Ù†ØªØ®Ø§Ø¨ Ø±Ù†Ú¯
    #     if zone == "green":
    #         color = color_green(intensity)
    #     elif zone == "yellow":
    #         color = color_yellow(intensity)
    #     else:
    #         color = color_red(intensity)
    
    #     # Ø±Ù†Ú¯ Ù…Ù‚Ø¯Ø§Ø±
    #     requests.append({
    #         "repeatCell": {
    #             "range": {
    #                 "sheetId": final_data.id,
    #                 "startRowIndex": r,
    #                 "endRowIndex": r+1,
    #                 "startColumnIndex": val_col_idx,
    #                 "endColumnIndex": val_col_idx+1
    #             },
    #             "cell": {"userEnteredFormat": {"backgroundColor": color}},
    #             "fields": "userEnteredFormat.backgroundColor"
    #         }
    #     })
    #     # Ø±Ù†Ú¯ Ø¯Ø±ØµØ¯
    #     requests.append({
    #         "repeatCell": {
    #             "range": {
    #                 "sheetId": final_data.id,
    #                 "startRowIndex": r,
    #                 "endRowIndex": r+1,
    #                 "startColumnIndex": perc_col_idx,
    #                 "endColumnIndex": perc_col_idx+1
    #             },
    #             "cell": {"userEnteredFormat": {"backgroundColor": color}},
    #             "fields": "userEnteredFormat.backgroundColor"
    #         }
    #     })
    
    # # ----------------------------
    # # 15) Ø§Ø¬Ø±Ø§ÛŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§
    # # ----------------------------
    # if requests:
    #     final_data.spreadsheet.batch_update({"requests": requests})
    # ----------------------------
    # 12) Ø±Ù†Ú¯â€ŒÙ‡Ø§ + Ù„Ø§Ú¯ Ø¯Ù„ÛŒÙ„ Ø±Ù†Ú¯ Ù†Ø´Ø¯Ù†
    # ----------------------------
    values = final_data.get_all_values()
    header = values[0]
    HOUR_COL = header.index("hour")
    
    def to_float(x):
        try:
            if x in ("", None):
                return None
            # Ø­Ø°Ù ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ú©Ø§Ù…Ø§ Ø¨Ø§ Ù†Ù‚Ø·Ù‡
            x = str(x).replace(',', '').strip()
            return float(x)
        except:
            return None
    
    def intensity(v):
        return 0.25 + v * 0.75
    
    def red(i):    return {"red": 1, "green": 1-i, "blue": 1-i}
    def green(i):  return {"red": 1-i, "green": 1, "blue": 1-i}
    def yellow(i): return {"red": 1, "green": 1, "blue": 1-i}
    
    requests = []
    not_colored_log = []   # ğŸ‘ˆ Ù„Ø§Ú¯ Ø§ØµÙ„ÛŒ
    
    for ci, name in enumerate(header):
        if not name.startswith("Ø¯Ø±ØµØ¯_"):
            continue
    
        city = name.replace("Ø¯Ø±ØµØ¯_", "")
        if city not in city_deadlines:
            not_colored_log.append(f"âŒ Ø³ØªÙˆÙ† {city}: Ø¯Ø¯Ù„Ø§ÛŒÙ† Ù†Ø¯Ø§Ø±Ø¯")
            continue
    
        val_col = ci - 1
        perc_col = ci
        deadline = city_deadlines[city]
    
        start_green = deadline - range_
        end_green   = deadline - 1
    
        for r in range(1, len(values)):
            hour = to_float(values[r][HOUR_COL])
            val  = to_float(values[r][val_col])
            perc = to_float(values[r][perc_col])
    
            # Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
            if hour is None or val is None:
                not_colored_log.append(
                    f"Ø±Ø¯ Ø´Ø¯ | Ø´Ù‡Ø±:{city} | Ø³Ø·Ø±:{r} | hour| Ø³Ø·Ø±:{val} ÛŒØ§ value Ù†Ø§Ù…Ø¹ØªØ¨Ø±"
                )
                continue
    
            hour = int(hour)
    
            # ----------------------------
            # ØªØ¹ÛŒÛŒÙ† Ø²ÙˆÙ†
            # ----------------------------
            if start_green <= hour <= end_green:
                zone = "green"
            else:
                if start_green >= 16:
                    if 12 <= hour < start_green:
                        zone = "yellow"
                    else:
                        zone = "red"
                elif 12 <= start_green < 16:
                    if (start_green - 4) <= hour < start_green:
                        zone = "yellow"
                    else:
                        zone = "red"
                else:
                    zone = "red"
    
            # Ø´Ø±Ø· Ø¯Ø±ØµØ¯ (ÙÙ‚Ø· Ø²Ø±Ø¯ Ùˆ Ù‚Ø±Ù…Ø²)
            if zone != "green":
                if perc is None:
                    not_colored_log.append(
                        f"Ø±Ø¯ Ø´Ø¯ | Ø´Ù‡Ø±:{city} | Ø³Ø§Ø¹Øª:{hour} | zone:{zone} | Ø¯Ø±ØµØ¯ Ø®Ø§Ù„ÛŒ"
                    )
                    continue
    
                if perc < min_perc_color:
                    not_colored_log.append(
                        f"Ø±Ø¯ Ø´Ø¯ | Ø´Ù‡Ø±:{city} | Ø³Ø§Ø¹Øª:{hour} | zone:{zone} | Ø¯Ø±ØµØ¯ {perc} < {min_perc_color}"
                    )
                    continue
    
            # Ø´Ø¯Øª
            # i = 1.0 if city == "ØªÙ‡Ø±Ø§Ù†" else intensity(0.5)
            i =  intensity(0.5)
    
            color = (
                green(i) if zone == "green"
                else yellow(i) if zone == "yellow"
                else red(i)
            )
    
            for c in (val_col, perc_col):
                requests.append({
                    "repeatCell": {
                        "range": {
                            "sheetId": final_data.id,
                            "startRowIndex": r,
                            "endRowIndex": r+1,
                            "startColumnIndex": c,
                            "endColumnIndex": c+1
                        },
                        "cell": {"userEnteredFormat": {"backgroundColor": color}},
                        "fields": "userEnteredFormat.backgroundColor"
                    }
                })
    
    # ----------------------------
    # 13) Ø§Ø¬Ø±Ø§ÛŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§
    # ----------------------------
    if requests:
        final_data.spreadsheet.batch_update({"requests": requests})
    

